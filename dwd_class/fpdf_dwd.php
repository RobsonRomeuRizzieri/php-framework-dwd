<?php class fpdf_dwd extends FPDF{	public $obj_entidade;	//Divisor de cada Linha na descrição do cabecalho é ;wd;  public $str_rua;  public $str_cidade;  public $str_estado;  public $str_email;  public $str_telefone;  public $str_CEP;  public $str_bairro;  public $str_url_pagina;  public $str_empresa;  public $str_titulo;  //Defini onde esta a imagem  public $str_imagem_url;  public $int_imagem_topo;  public $int_imagem_esquerdo;  public $int_imagem_largura;  public $int_imagem_altura;  private $str_imagem_wd_url;  private $int_imagem_wd_topo;  private $int_imagem_wd_esquerdo;  public $int_imagem_wd_largura;  public $int_imagem_wd_altura;  private $int_somar_topo;  private $int_somar_largura;  private $tipo_pagina;  private $medida;  private $formato_pagina;	public function __construct($orientation='P',$unit='mm',$format='A4'){		$this->tipo_pagina = $orientation;		$this->medida = $unit;		$this->formato_pagina = $format;	  parent::__construct($this->tipo_pagina,$this->medida,$this->formato_pagina);	  $this->str_imagem_url = "../../dwd_img/logo_tipo2.jpg";	  $this->str_titulo = "Titulo Relatório DWD";    //$this->str_campo_margem_esquerda = "10;wd;25;wd;80;wd;140;wd;190;wd;205;wd;220";		$this->int_imagem_topo = 10;		$this->int_imagem_esquerdo = 10;		$this->int_imagem_largura = 93;		$this->int_imagem_altura = 18;		$this->int_imagem_wd_largura = 30;		$this->int_imagem_wd_altura = 10;	}	function Header()	{		$this->Ln(5);    $this->Image($this->str_imagem_url,$this->int_imagem_esquerdo ,$this->int_imagem_topo,$this->int_imagem_largura,$this->int_imagem_altura);		$this->SetFont('Arial','B',12);	  $this->Cell(0,0,$this->str_titulo,0,0,'R');		$this->SetFont('Arial','',5);	  $this->Ln(2);	  $this->SetX($this->int_imagem_largura + 20);	  $this->Cell(0,5,'Rua: '.$this->str_rua.' - '.$this->str_bairro.' - '.$this->str_CEP.' - '.$this->str_cidade.' - '.$this->str_estado,0,0,'R');	  $this->Ln();	  $this->SetX($this->int_imagem_largura + 20);	  $this->Cell(0,0,'E-mail: '.$this->str_email,0,0,'R');	  $this->Ln();	  $this->SetX($this->int_imagem_largura + 20);	  $this->Cell(0,5,'Telefone: '.$this->str_telefone,0,0,'R');	  $this->Ln();	  $this->SetX($this->int_imagem_largura + 20);	  $this->Cell(0,0,'Página WEB: '.$this->str_url_pagina,0,0,'R');	  //Line break	  $this->Ln(2);		//Títulos das colunas		$this->SetFont('Arial', 'B', 10);		//Define a cor RGB do fundo da celula		$this->SetFillColor(178,178,178);    $cont_desc = count($this->obj_entidade->arr_campo);    $int_maregem = 0;    $int_tamanho_total = 0;    for ($i = 0; $i < $cont_desc; $i++){     	if ($this->obj_entidade->arr_campo[$i]["rel_exibir"] != "nao"){	    	if ($this->obj_entidade->arr_campo[$i]["rel_int_tamanho"] > 0){		    	  $int_margem = $this->obj_entidade->arr_campo[$i]["rel_int_tamanho"];	    	}	else{				  $int_margem = $int_margem + 30;	    	}				$int_tamanho = $int_margem;	      $int_tamanho_total = $int_tamanho_total + $int_tamanho;				$w=$int_tamanho;	      //Save the current position	      $x=$this->GetX();	      $y=$this->GetY();	      //Print the text				$this->MultiCell($int_tamanho,6,$this->obj_entidade->arr_campo[$i]["descricao"],0,'L',1);	      //Put the position to the right of the cell	      $this->SetXY($x+$w,$y);				$nb=max($nb,$this->NbLines($int_tamanho,$this->obj_entidade->arr_campo[$i]["descricao"]));		  }		}		if ($this->obj_entidade->rel_tipo_pagina != "H") {		  $int_tamanho = 595.28 - ($int_tamanho_total + 405);		}else{		  $int_tamanho = 841.89 - ($int_tamanho_total + 565);		}		$w= $int_tamanho;    //Save the current position    $x=$this->GetX();    $y=$this->GetY();    //Print the text  	$this->MultiCell($int_tamanho,6,' ',0,'L',1);    //Put the position to the right of the cell    $this->SetXY($x+$w,$y);		$nb=max($nb,$this->NbLines($int_tamanho,' '));    //Define quebra de linha    $h=6*$nb;		$this->ln($h);	}	//Rodapé do Relatório	function Footer()	{	  $usuarioNome = $_SESSION["usuario_login"];	  //Position at 1.5 cm from bottom	  $this->SetY(-22);	  //Arial italic 8	  $this->SetFont('Arial','I',7);	  //Page number		if ($this->tipo_pagina == "P"){      $this->Line(10,275,200 + $this->int_somar_largura,275);    }else{			$this->Line(10,188,286 + $this->int_somar_largura,188);		}		$empresaNome = $_SESSION["filial_nome"];    //Ajusta a fonte    $this->SetFont('Arial','',9);		$this->str_imagem_wd_url = "../../dwd_img/logo_tipo.jpg";		if ($this->tipo_pagina == "P"){			$this->int_imagem_wd_topo = 276;		}else{			$this->int_imagem_wd_topo = 189;		}		$this->int_imagem_wd_esquerdo = 10;    $this->Image($this->str_imagem_wd_url,$this->int_imagem_wd_esquerdo,$this->int_imagem_wd_topo,$this->int_imagem_wd_largura,$this->int_imagem_wd_altura);    //Titulo do relatório   	$this->SetX(40);		$this->Cell(0,6,"Unidade: ".$empresaNome);		$this->Cell(0,6,'Pagina: '.$this->PageNo(),0,0,'R');	  $this->Ln();   	$this->SetX(40);  	$this->Cell(0,3,'Emitido por '.$usuarioNome.' em: '.date('d/m/Y', mktime())." - ".date('H:m'));		$this->SetFont('Arial','I',5); 		if ($this->tipo_pagina == "P"){    	$this->SetX(90);    }else{			$this->SetX(140);		}    $this->Write(10,'Powered By Develop World Dynamics','http://www.developwd.com');	}  function criar(){		$this->SetCreator('Develop World Dynamics');		$this->SetAuthor($usuarioNome . " - " . $empresaNome . " - Develop World Dynamics (DWD)" );		$this->SetTitle($this->str_titulo);		$this->SetSubject('Relatório gerado automaticamente pelo sistema');		$this->AliasNbPages();		$this->AddPage();    $int_maregem = 0;    $matriz = $this->obj_entidade->consultar();		$bolMudaCor = true;    $this->Ln(-6);		//Monta as linhas com os dados da query		$this->SetFont('Arial','',10);    $cont_reg = 0;    $int_linha_reg = 35;	  if (!empty($matriz)){		  foreach($matriz as $row){        if ($int_margem == 0){          $this->ln();        }			  if ($bolMudaCor){				    $intVermelho = 255;				    $intVerde = 255;				    $intAzul = 255;				    $bolMudaCor = false;			  }else{			    $intVermelho = 225;			    $intVerde = 225;			    $intAzul = 225;			    $bolMudaCor = true;			  }			  $this->SetFillColor($intVermelho,$intVerde,$intAzul);        $cont_campo = count($this->obj_entidade->arr_campo);        $int_tamanho_total = 0;        for ($i = 0; $i < $cont_campo; $i++){		    	if ($this->obj_entidade->arr_campo[$i]["rel_exibir"] != "nao"){			    	if ($this->obj_entidade->arr_campo[$i]["rel_int_tamanho"] != ""){				    	  $int_margem = $this->obj_entidade->arr_campo[$i]["rel_int_tamanho"];			    	}	else{						  $int_margem = $int_margem + 30;			    	}						$int_tamanho = $int_margem;	          if ($this->obj_entidade->arr_campo[$i]["entidade"] != ""){            	if ($this->obj_entidade->arr_campo[$i]["entidade_campo_chave"] != ""){	              $str_valor = $row[$this->obj_entidade->arr_campo[$i]["nome"]."_".$this->obj_entidade->arr_campo[$i]["entidade_campo_chave"]];	            }else{	              $str_valor = $row[$this->obj_entidade->arr_campo[$i]["nome"]."_".$this->obj_entidade->arr_campo[$i]["entidade"]];	            }            }else if ($this->obj_entidade->arr_campo[$i]["tipo"] == "date"){				      $obj_data = new com_data_configuracao();				      //Converte data do banco para data do usuário				      $str_valor = $obj_data->wd_obter($row[$this->obj_entidade->arr_campo[$i]["nome"]],$_SESSION["banco_tipo"]);	          }else{	            $str_valor = $row[$this->obj_entidade->arr_campo[$i]["nome"]];	          }	          if (($str_valor == 1) && ($this->obj_entidade->arr_campo[$i]["cad_tipo_campo"] == "checkbox")){						  $str_valor = "Sim";						}else if (($str_valor == 0) && ($this->obj_entidade->arr_campo[$i]["cad_tipo_campo"] == "checkbox")){						  $str_valor = "Não";						}            $this->obj_entidade->arr_campo[$i]["valor"] = $str_valor;	        }        }	          $nb = 0;        for ($i = 0; $i < $cont_campo; $i++){        	if ($this->obj_entidade->arr_campo[$i]["rel_exibir"] != "nao"){	          $nb=max($nb,$this->NbLines($this->obj_entidade->arr_campo[$i]["rel_int_tamanho"],$this->obj_entidade->arr_campo[$i]["valor"]));	        }	      }	          $h=5*$nb;	          $this->CheckPageBreak($h);        for ($i = 0; $i < $cont_campo; $i++){ 		    	if ($this->obj_entidade->arr_campo[$i]["rel_exibir"] != "nao"){						$w=$this->obj_entidade->arr_campo[$i]["rel_int_tamanho"];			      $int_tamanho_total = $int_tamanho_total + $this->obj_entidade->arr_campo[$i]["rel_int_tamanho"];	          //Save the current position	          $x=$this->GetX();	          $y=$this->GetY();	          $nb_max=$this->NbLines($this->obj_entidade->arr_campo[$i]["rel_int_tamanho"],$this->obj_entidade->arr_campo[$i]["valor"]);	          $str_quebra_linha = "";	          if ($nb_max < $nb){	            for($ij=1;$ij<$nb;$ij++)	              $str_quebra_linha .= "\n ";	          }else{	            //$str_quebra_linha = "";	          }						$this->MultiCell($this->obj_entidade->arr_campo[$i]["rel_int_tamanho"],5,$this->obj_entidade->arr_campo[$i]["valor"].$str_quebra_linha,0,'L',1);	          //Put the position to the right of the cell	          $this->SetXY($x+$w,$y);	        }				}				if ($this->obj_entidade->rel_tipo_pagina != "H") {				  $int_tamanho = 595.28 - ($int_tamanho_total + 405);				}else{				  $int_tamanho = 841.89 - ($int_tamanho_total + 565);				}				$w= $int_tamanho;		    //Save the current position		    $x=$this->GetX();		    $y=$this->GetY();		    //Print the text		  	$this->MultiCell($int_tamanho,6,'',0,'L',1);		    //Put the position to the right of the cell		    $this->SetXY($x+$w,$y);				$nb=max($nb,$this->NbLines($int_tamanho,''));				$this->ln($h);				$cont_reg++;		  }	  }		$this->SetFont('Arial', 'B', 8);		$this->ln();		$this->Cell(0,6, 'Total de registros listados: ' . $cont_reg,'T');		//Gera o PDF		$this->Output();  }  private function CheckPageBreak($h)  {    //If the height h would cause an overflow, add a new page immediately    if($this->GetY()+$h>$this->PageBreakTrigger)        $this->AddPage($this->CurOrientation);  }	private function NbLines($w,$txt)  {    //Computes the number of lines a MultiCell of width w will take    $cw=&$this->CurrentFont['cw'];    if($w==0)        $w=$this->w-$this->rMargin-$this->x;    $wmax=($w-2*$this->cMargin)*1000/$this->FontSize;    $s=str_replace("\r",'',$txt);    $nb=strlen($s);    if($nb>0 and $s[$nb-1]=="\n")        $nb--;    $sep=-1;    $i=0;    $j=0;    $l=0;    $nl=1;    while($i<$nb)    {        $c=$s[$i];        if($c=="\n")        {            $i++;            $sep=-1;            $j=$i;            $l=0;            $nl++;            continue;        }        if($c==' ')            $sep=$i;        $l+=$cw[$c];        if($l>$wmax)        {            if($sep==-1)            {                if($i==$j)                    $i++;            }            else                $i=$sep+1;            $sep=-1;            $j=$i;            $l=0;            $nl++;        }        else            $i++;    }    return $nl;  }}?>